name: 'Auto Release with Calendar Versioning'
description: 'Automatically create GitHub releases using semantic-release when pushing to specified branches with calendar versioning'
author: 'GitHub Actions Workflows'

inputs:
  github-token:
    description: 'GitHub token for authentication'
    required: true
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '18'
  release-branches:
    description: 'Branches to release from (JSON array format)'
    required: false
    default: '["main", "master"]'
  dry-run:
    description: 'Whether to run in dry-run mode'
    required: false
    default: 'false'
  working-directory:
    description: 'Working directory for the action'
    required: false
    default: '.'
  semantic-release-version:
    description: 'Semantic Release version to use'
    required: false
    default: '22'

outputs:
  new-release-published:
    description: 'Whether a new release was published'
    value: ${{ steps.semantic-release.outputs.new-release-published }}
  new-release-version:
    description: 'Version of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-version }}
  new-release-git-tag:
    description: 'Git tag of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-git-tag }}
  new-release-git-head:
    description: 'Git SHA of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-git-head }}

runs:
  using: 'composite'
  steps:
    - name: Checkout 코드
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ inputs.github-token }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Install local dependencies (if package.json exists)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        if [ -f "package.json" ]; then
          echo "📦 Installing project dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          elif [ -f "pnpm-lock.yaml" ]; then
            npm install -g pnpm
            pnpm install --frozen-lockfile
          else
            npm install
          fi
        else
          echo "⚠️ No package.json found"
          exit 1
        fi

    - name: Set execution permission for scripts
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        chmod +x scripts/calendar-version-wrapper.js

    - name: Run semantic-release with calendar versioning
      id: semantic-release
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GIT_AUTHOR_NAME: github-actions[bot]
        GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        GIT_COMMITTER_NAME: github-actions[bot]
        GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
      run: |
        # JSON 배열을 공백으로 구분된 문자열로 변환
        BRANCHES=$(echo '${{ inputs.release-branches }}' | jq -r '.[]' | paste -sd ' ')
        
        if [ "${{ inputs.dry_run }}" = "true" ]; then
          echo "🚀 Running semantic-release@${{ inputs.semantic-release-version }} in dry-run mode..."
          echo "📅 Calendar Versioning 형식: year.month.minor.fix"
          npx semantic-release@${{ inputs.semantic-release-version }} --dry-run --branches $BRANCHES
        else
          echo "🚀 Running semantic-release@${{ inputs.semantic-release-version }}..."
          echo "📅 Calendar Versioning 형식: year.month.minor.fix"
          npx semantic-release@${{ inputs.semantic-release-version }} --branches $BRANCHES
        fi

    - name: Create calendar version tag and release
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        DRY_RUN: ${{ inputs.dry_run }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        if [ "$DRY_RUN" != "true" ] && [ -n "$CALENDAR_VERSION" ]; then
          echo "Creating calendar version tag: v$CALENDAR_VERSION"
          
          git tag "v$CALENDAR_VERSION"
          git push origin "v$CALENDAR_VERSION"
          echo "Calendar version tag created: v$CALENDAR_VERSION"
          
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          echo "Creating GitHub release with calendar version..."
          
          RELEASE_NOTES="Calendar Versioning Release v$CALENDAR_VERSION"
          gh release create "v$CALENDAR_VERSION" --title "v$CALENDAR_VERSION" --notes "$RELEASE_NOTES" --latest
          echo "GitHub release created: v$CALENDAR_VERSION"
          
          echo "Updating PR comments with calendar version..."
          RECENT_PRS=$(gh pr list --state merged --limit 10 --json number,mergedAt --jq '.[] | select(.mergedAt != null) | .number')
          
          for PR_NUMBER in $RECENT_PRS; do
            COMMENT_ID=$(gh api repos/:owner/:repo/issues/$PR_NUMBER/comments --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("This PR is included in version"))) | .id' | head -n1)
            
            if [ -n "$COMMENT_ID" ]; then
              gh api repos/:owner/:repo/issues/comments/$COMMENT_ID -X DELETE || true
              
              COMMENT_TEXT="This PR is included in version $CALENDAR_VERSION. The release is available on GitHub: https://github.com/$GITHUB_REPOSITORY/releases/tag/v$CALENDAR_VERSION"
              gh pr comment $PR_NUMBER --body "$COMMENT_TEXT"
              
              echo "Updated PR #$PR_NUMBER comment with calendar version"
              break
            fi
          done
        fi

branding:
  icon: 'calendar'
  color: 'purple' 