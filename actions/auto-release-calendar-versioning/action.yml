name: 'Auto Release with Calendar Versioning'
description: 'Automatically create GitHub releases using semantic-release when pushing to specified branches with calendar versioning'
author: 'GitHub Actions Workflows'

inputs:
  github-token:
    description: 'GitHub token for authentication'
    required: true
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '18'
  release-branches:
    description: 'Branches to release from (JSON array format)'
    required: false
    default: '["main", "master"]'
  dry-run:
    description: 'Whether to run in dry-run mode'
    required: false
    default: 'false'
  working-directory:
    description: 'Working directory for the action'
    required: false
    default: '.'
  semantic-release-version:
    description: 'Semantic Release version to use'
    required: false
    default: '22'

outputs:
  new-release-published:
    description: 'Whether a new release was published'
    value: ${{ steps.semantic-release.outputs.new-release-published }}
  new-release-version:
    description: 'Version of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-version }}
  new-release-git-tag:
    description: 'Git tag of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-git-tag }}
  new-release-git-head:
    description: 'Git SHA of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-git-head }}

runs:
  using: 'composite'
  steps:
    - name: Checkout 코드
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ inputs.github-token }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Install local dependencies (if package.json exists)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        if [ -f "package.json" ]; then
          echo "📦 Installing project dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          elif [ -f "pnpm-lock.yaml" ]; then
            npm install -g pnpm
            pnpm install --frozen-lockfile
          else
            npm install
          fi
        else
          echo "⚠️ No package.json found"
          exit 1
        fi

    - name: Set execution permission for scripts
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        chmod +x scripts/generate-version.js
        chmod +x scripts/calendar-version-plugin.js
        chmod +x scripts/calendar-version-wrapper.js

    - name: Run semantic-release with calendar versioning
      id: semantic-release
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GIT_AUTHOR_NAME: github-actions[bot]
        GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        GIT_COMMITTER_NAME: github-actions[bot]
        GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
      run: |
        # JSON 배열을 공백으로 구분된 문자열로 변환
        BRANCHES=$(echo '${{ inputs.release-branches }}' | jq -r '.[]' | paste -sd ' ')
        
        if [ "${{ inputs.dry_run }}" = "true" ]; then
          echo "🚀 Running semantic-release@${{ inputs.semantic-release-version }} in dry-run mode..."
          echo "📅 Calendar Versioning 형식: year.month.minor.fix"
          npx semantic-release@${{ inputs.semantic-release-version }} --dry-run --branches $BRANCHES
        else
          echo "🚀 Running semantic-release@${{ inputs.semantic-release-version }}..."
          echo "📅 Calendar Versioning 형식: year.month.minor.fix"
          npx semantic-release@${{ inputs.semantic-release-version }} --branches $BRANCHES
        fi

    - name: Override Git tag with calendar version
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        if [ "${{ inputs.dry_run }}" != "true" ] && [ -n "$CALENDAR_VERSION" ]; then
          echo "🏷️ Creating calendar version tag: v$CALENDAR_VERSION"
          
          # 기존 semantic release 태그 삭제 (로컬)
          SEMANTIC_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ "$SEMANTIC_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "🗑️ Removing semantic version tag: $SEMANTIC_TAG"
            git tag -d "$SEMANTIC_TAG" || true
            git push origin ":refs/tags/$SEMANTIC_TAG" || true
          fi
          
          # Calendar version 태그 생성
          git tag "v$CALENDAR_VERSION"
          git push origin "v$CALENDAR_VERSION"
          
          echo "✅ Calendar version tag created: v$CALENDAR_VERSION"
          
          # GitHub release도 calendar version으로 업데이트
          if command -v gh &> /dev/null; then
            echo "📝 Updating GitHub release to calendar version..."
            # 최신 release를 calendar version으로 업데이트
            LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
            if [ -n "$LATEST_RELEASE" ] && [[ "$LATEST_RELEASE" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              gh release edit "$LATEST_RELEASE" --tag "v$CALENDAR_VERSION" --title "v$CALENDAR_VERSION" || true
            fi
          fi
        fi

branding:
  icon: 'calendar'
  color: 'purple' 